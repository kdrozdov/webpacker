<%= shebang %>
$stdout.sync = true

require 'shellwords'
require 'json'

ENV['RAILS_ENV'] ||= 'development'
RAILS_ENV = ENV['RAILS_ENV']

ENV['NODE_ENV'] ||= RAILS_ENV
NODE_ENV = ENV['NODE_ENV']

APP_PATH = File.expand_path('../', __dir__)
ESCAPED_APP_PATH = APP_PATH.shellescape

begin
  package_json = File.read(File.join(APP_PATH, 'package.json'))
  config = JSON.parse(package_json)

  NODE_MODULES_PATH = "#{File.join(ESCAPED_APP_PATH, config['webpacker']['nodeModulesPath'])}"
  WEBPACK_CONFIG_PATH = "#{File.join(ESCAPED_APP_PATH, config['webpacker']['configPath'])}"
  PACKS_PATH = "#{File.join(ESCAPED_APP_PATH, config['webpacker']['distPath'])}"
  WEBPACK_BIN  = "#{NODE_MODULES_PATH}/.bin/webpack-dev-server"
  WEBPACK_CONFIG = "#{WEBPACK_CONFIG_PATH}/development.hot.js"

  if config['devServer'] && !config['devServer']['enabled']
    puts "Error: If you want to use webpack-dev-server, you will need to enable " \
        "webpack-dev-server from your package.json { devServer: { enabled: true } }"
    exit!
  end
rescue Errno::ENOENT, NoMethodError
  puts 'Package.json or [webpacker, devServer] config key not found.'
  puts 'Please run bundle exec rails webpacker:install to install webpacker'
  exit!
end

Dir.chdir(APP_PATH) do
  exec "NODE_PATH=#{NODE_MODULES_PATH} #{WEBPACK_BIN} " \
  "--config #{WEBPACK_CONFIG} --content-base #{PACKS_PATH} #{ARGV.join(" ")}"
end
